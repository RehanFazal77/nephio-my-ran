# ConfigMap with node labeling script
apiVersion: v1
kind: ConfigMap
metadata: # kpt-merge: kube-system/node-config-script
  name: node-config-script
  namespace: kube-system
  annotations:
    internal.kpt.dev/upstream-identifier: '|ConfigMap|kube-system|node-config-script'
data:
  label-nodes.sh: "#!/bin/bash\n# Auto-label nodes based on cluster context\n\nCLUSTER_NAME=\"${CLUSTER_NAME:-my-ran}\" # kpt-set: ${cluster-name}\nWORKLOAD_TYPE=\"${WORKLOAD_TYPE:-ran}\"  # ran or core\nSITE_ID=\"${SITE_ID:-site-01}\"\n\necho \"Labeling nodes for cluster: $CLUSTER_NAME\"\n\nfor node in $(kubectl get nodes -o name); do\n  echo \"Labeling $node...\"\n  \n  kubectl label $node \\\n    nephio.org/cluster-name=$CLUSTER_NAME \\\n    nephio.org/cluster-type=workload \\\n    nephio.org/site-id=$SITE_ID \\\n    nephio.org/workload-type=$WORKLOAD_TYPE \\\n    topology.kubernetes.io/zone=zone-a \\\n    --overwrite\n    \n  # Add hardware capability labels if needed\n  # kubectl label $node hw.nephio.org/sriov=true --overwrite\n  # kubectl label $node hw.nephio.org/dpdk=true --overwrite\ndone\n\necho \"Node labeling complete!\"\nkubectl get nodes --show-labels\n"
---
# Job to apply node labels automatically (optional)
apiVersion: batch/v1
kind: Job
metadata: # kpt-merge: kube-system/label-nodes-job
  name: label-nodes-job
  namespace: kube-system
  annotations:
    internal.kpt.dev/upstream-identifier: 'batch|Job|kube-system|label-nodes-job'
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: node-labeler
      restartPolicy: OnFailure
      containers:
      - name: node-labeler
        image: bitnami/kubectl:latest
        command: ["/bin/bash", "/scripts/label-nodes.sh"]
        env:
        - name: CLUSTER_NAME
          value: "my-ran" # kpt-set: ${cluster-name}
        - name: WORKLOAD_TYPE
          value: "ran"
        - name: SITE_ID
          value: "site-ran-01"
        volumeMounts:
        - name: script
          mountPath: /scripts
      volumes:
      - name: script
        configMap:
          name: node-config-script
          defaultMode: 0755
---
apiVersion: v1
kind: ServiceAccount
metadata: # kpt-merge: kube-system/node-labeler
  name: node-labeler
  namespace: kube-system
  annotations:
    internal.kpt.dev/upstream-identifier: '|ServiceAccount|kube-system|node-labeler'
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata: # kpt-merge: /node-labeler
  name: node-labeler
  annotations:
    internal.kpt.dev/upstream-identifier: 'rbac.authorization.k8s.io|ClusterRole|default|node-labeler'
rules:
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list", "patch", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata: # kpt-merge: /node-labeler
  name: node-labeler
  annotations:
    internal.kpt.dev/upstream-identifier: 'rbac.authorization.k8s.io|ClusterRoleBinding|default|node-labeler'
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: node-labeler
subjects:
- kind: ServiceAccount
  name: node-labeler
  namespace: kube-system
